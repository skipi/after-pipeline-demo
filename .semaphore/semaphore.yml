version: v1.0
name: after_pipeline example
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
after_pipeline:
  task:
    jobs:
      - name: Reports
        commands:
          - test-results gen-pipeline-report
      - name: Long job
        commands:
          - echo I RUN FOR A LONG TIME
          - sleep 10
      - name: Failed job
        commands:
          - echo I FAIL!
          - sleep 1
          - exit 1
      - name: Pipeline metrics
        commands:
          - >-
            echo "SEMAPHORE_PIPELINE_DURATION=${SEMAPHORE_PIPELINE_DURATION}" &&
            echo "SEMAPHORE_PIPELINE_DURATION_INIT=${SEMAPHORE_PIPELINE_DURATION_INIT}" &&
            echo "SEMAPHORE_PIPELINE_DURATION_QUEUEING=${SEMAPHORE_PIPELINE_DURATION_QUEUEING}" &&
            echo "SEMAPHORE_PIPELINE_DURATION_RUNNING=${SEMAPHORE_PIPELINE_DURATION_RUNNING}" &&
            echo "SEMAPHORE_PIPELINE_CREATED_AT=${SEMAPHORE_PIPELINE_CREATED_AT}($(date -d @${SEMAPHORE_PIPELINE_CREATED_AT}))" &&
            echo "SEMAPHORE_PIPELINE_STARTED_AT=${SEMAPHORE_PIPELINE_STARTED_AT}($(date -d @${SEMAPHORE_PIPELINE_STARTED_AT}))" &&
            echo "SEMAPHORE_PIPELINE_DONE_AT=${SEMAPHORE_PIPELINE_DONE_AT}($(date -d @${SEMAPHORE_PIPELINE_DONE_AT}))"
blocks:
  - name: Run tests
    task:
      jobs:
        - name: Test
          parallelism: 2
          commands:
            - sleep 10
            - checkout
            - echo Publishing ${SEMAPHORE_JOB_INDEX}/${SEMAPHORE_JOB_COUNT} test
            - test-results publish test/junit-${SEMAPHORE_JOB_INDEX}.xml
        - name: Test failed
          parallelism: 1
          commands:
            - sleep 10
            - checkout
            - echo Publishing ${SEMAPHORE_JOB_INDEX}/${SEMAPHORE_JOB_COUNT} test
            - test-results publish test/junit-failed-${SEMAPHORE_JOB_INDEX}.xml
            - exit 1
promotions:
  - name: Promo
    pipeline_file: promo.yml